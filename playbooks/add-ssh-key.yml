---
- name: "Add SSH public key to deploy user"
  hosts: all
  become: true
  become_method: sudo

  vars:
    key_file: ""  # Path to public key file (e.g., keys/q.pub)

  tasks:
    - name: Validate key_file variable
      assert:
        that:
          - key_file is defined
          - key_file | length > 0
        fail_msg: "Please specify key_file variable. Example: -e 'key_file=keys/q.pub'"

    - name: Read public key from file
      set_fact:
        public_key_content: "{{ lookup('file', playbook_dir + '/../' + key_file) }}"
      delegate_to: localhost
      become: false

    - name: Ensure deploy user exists
      user:
        name: deploy
        state: present
        shell: /bin/bash
        createhome: yes

    - name: Ensure .ssh directory exists for deploy user
      file:
        path: /home/deploy/.ssh
        state: directory
        owner: deploy
        group: deploy
        mode: 0700

    - name: Add SSH public key to authorized_keys
      authorized_key:
        user: deploy
        key: "{{ public_key_content }}"
        state: present
