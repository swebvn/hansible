---

- name: Ensure schedule is setup on the server
  hosts: all
  become: true
  become_method: sudo

  tasks:
    - name: Check if current symlink exists (new structure)
      stat:
        path: /home/deploy/current
      register: current_link

    - name: Setup the schedule (new symlink structure)
      cron:
        name: "lucommerce-schedule"
        minute: "*/1"
        user: deploy
        job: "cd /home/deploy/current && php artisan schedule:run >> /dev/null 2>&1"
        state: present
      when: current_link.stat.exists

